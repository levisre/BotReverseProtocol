/*
- Generate Session Key and RSA Blob 
- Server Public Key and Client Public Key are grabbed from binary file
- Extracted Format as follow to Microsoft Cryptographic Provider
- Refs: https://msdn.microsoft.com/en-us/library/windows/desktop/aa375601(v=vs.85).aspx
- Created by Levis
*/

#include <windows.h>
#include <wincrypt.h>
#include <stdio.h>
#include <string.h>
// Server Public Key
BYTE serverPub[0x94] = {0x06,0x02,0x00,0x00,0x00,0xA4,0x00,0x00,0x52,0x53,0x41,0x31,0x00,0x04,0x00,0x00,0x01,0x00,0x01,0x00,0xD1,0xB1,0x99,0x84,0x91,0x7F,0x12,0x15,0xC5,0x97,0xBF,0x05,0xF4,0x61,0x63,0xD8,0xC2,0xEA,0x54,0x35,0xB0,0x33,0xFB,0x0D,0x0A,0xA7,0x52,0x98,0x6F,0x7E,0x52,0xEB,0x95,0xF8,0x66,0xDB,0xE5,0xC8,0x23,0xBE,0x5D,0x09,0x63,0x86,0x15,0x0A,0xCA,0x3F,0x0B,0xBE,0x7A,0xE6,0x46,0xD9,0x6C,0x3D,0x0D,0x59,0xAC,0xF4,0x87,0xCB,0x0A,0xE6,0x06,0xDB,0x64,0x9E,0xD3,0xBA,0x80,0x66,0x32,0xD8,0xF9,0xAC,0x29,0x05,0xCC,0xBB,0xEC,0xDC,0xAE,0x3A,0x24,0x15,0xB4,0xDD,0xFD,0xBF,0xE3,0x99,0x91,0x62,0x01,0xCF,0x19,0x48,0xFA,0xA7,0x3C,0x59,0x24,0xBD,0xD3,0xB3,0x31,0x7E,0x6A,0x9B,0xD5,0x9B,0x63,0xF9,0xF8,0x30,0x00,0xEA,0x08,0xE9,0xAB,0x17,0x70,0x57,0xD7,0xA2,0xCB,0xC4};
// Client Public Key
BYTE clientPub[0x94] = {0x06, 0x02, 0x00, 0x00, 0x00, 0xa4, 0x00, 0x00, 0x52, 0x53, 0x41, 0x31, 0x00, 0x04, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x51, 0x1e, 0xee, 0x58, 0x2e, 0x6b, 0x18, 0xc0, 0x1d, 0x4d, 0x38, 0xd9, 0x66, 0xe6, 0xec, 0xd5, 0x71, 0xfc, 0xf5, 0xf6, 0x79, 0xaf, 0x7e, 0xe7, 0x2f, 0x5a, 0x4b, 0x66, 0xa9, 0x12, 0xf9, 0x67, 0x96, 0xef, 0x94, 0x33, 0xa5, 0xb1, 0x7a, 0xd8, 0x03, 0x3b, 0x34, 0x91, 0x7d, 0xab, 0x54, 0x64, 0xd5, 0x78, 0x97, 0xcc, 0xa0, 0xb9, 0xe5, 0x19, 0x02, 0xdb, 0xf8, 0xa3, 0xe7, 0x20, 0x56, 0x56, 0xa2, 0xe0, 0x02, 0xf1, 0x5d, 0x2c, 0x76, 0xff, 0xe8, 0x52, 0x3d, 0xfd, 0xc8, 0xa6, 0x6e, 0xe4, 0xa8, 0xed, 0xc0, 0xd3, 0xcd, 0x92, 0xe8, 0x9b, 0x7b, 0xaf, 0x79, 0x0e, 0xf4, 0x2c, 0xbc, 0x54, 0xed, 0x3a, 0xde, 0x67, 0x36, 0xc7, 0x0c, 0xa6, 0x0f, 0xdc, 0x88, 0xec, 0x4b, 0x78, 0x9e, 0x1b, 0x25, 0xe7, 0x79, 0xfd, 0xcd, 0x89, 0x5f, 0x83, 0x4b, 0x75, 0xfa, 0x30, 0x2c, 0xe6, 0x72, 0xb6};

// Parts of these code are ripped from binary file 
int main(int argc, char const *argv[])
{
	DWORD pbDataLen = 4096, exportedRSALen = 4096;
	printf("Size of key chunk : %x", sizeof(clientPub));
	BYTE* exported_rsa = (BYTE*) malloc(0x1000);
	BYTE* pbData = (BYTE*) malloc(0x1000);
	HCRYPTKEY hKey;
	HCRYPTPROV hProv = 0 ;
	if(CryptAcquireContextA(&hProv, 0, MS_ENHANCED_PROV, PROV_RSA_FULL, 0) && GetLastError()  != ERROR_SUCCESS ) {
		CryptAcquireContextA(&hProv, 0, MS_ENHANCED_PROV, 1, 8 );
	}
	if(hProv){
		hKey = 0;
		if(CryptGenKey(hProv, CALG_RC4,  0x800001, &hKey)) {
				// Get KEYBLOB Length
			if(CryptExportKey(hKey,0,PLAINTEXTKEYBLOB/*8*/,0,NULL,&pbDataLen)) {
				// Export Session KEYBLOB and save to FIle
				CryptExportKey(hKey,0, PLAINTEXTKEYBLOB, 0, pbData, &pbDataLen);
				BYTE* plainKey = (BYTE*) malloc (pbDataLen + 1);
				memcpy(plainKey, pbData, pbDataLen);
				FILE* fp = fopen("rc4plain.blob", "wb");
				fwrite(plainKey, pbDataLen, 1, fp);
				fclose(fp);
				free(plainKey);
				pbData = 0;
				if(CryptImportKey(hProv, clientPub, sizeof(clientPub), 0, 1, (HCRYPTKEY*)&pbData)) {
					BOOL result;
					// Export PUBLICKEYBLOB according to session KEYBLOB
					result = CryptExportKey(hKey, (HCRYPTKEY)pbData, 1, 0, exported_rsa, &exportedRSALen);
					printf("Exported Key Len: %x", strlen((char*)exported_rsa));
					FILE* fp2 = fopen("session_rsa.blob", "wb");
					fwrite(exported_rsa, exportedRSALen, 1, fp2);
					fclose(fp2);
					CryptDestroyKey((HCRYPTKEY)pbData);
				}
			}
			CryptDestroyKey(hKey);
		}
		CryptReleaseContext(hProv, 0);
	}
	free(exported_rsa);
	return 0;
}
